---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { absoluteUrl, getBasePath, prefixWithBase } from '../utils/paths';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const plans = (await getCollection('plans')).sort((a, b) => b.data.sqft - a.data.sqft);
const land = (await getCollection('land')).sort((a, b) => a.data.address.localeCompare(b.data.address));
const basePath = getBasePath(Astro.site);

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const publicDir = path.resolve(__dirname, '../../public');

interface StaticLink {
  href: string;
  title: string;
}

const decodeFileTitle = (fileName: string): string => {
  const withoutExt = fileName.replace(/\.(html|md)$/i, '');
  const normalized = withoutExt.replace(/_/g, ' ');
  return normalized
    .split(/[-\s]+/)
    .filter(Boolean)
    .map((part) => (part === part.toUpperCase() ? part : part.charAt(0).toUpperCase() + part.slice(1)))
    .join(' ');
};

async function listStaticFiles(subdir: string): Promise<string[]> {
  const targetDir = path.join(publicDir, subdir);
  const entries = await fs.readdir(targetDir, { withFileTypes: true });
  return entries
    .filter((entry) => entry.isFile() && (/\.html$/i.test(entry.name) || /\.md$/i.test(entry.name)))
    .map((entry) => entry.name)
    .sort((a, b) => a.localeCompare(b));
}

function buildStaticLinks(files: string[], baseHref: string): StaticLink[] {
  const normalizedBase = baseHref === '/' ? '' : baseHref.replace(/\/$/, '');
  return files.map((file) => {
    const rawPath = `${normalizedBase}/${file}`;
    const href = encodeURI(rawPath.startsWith('/') ? rawPath : `/${rawPath}`);
    return { href, title: decodeFileTitle(file) };
  });
}

const [blogFiles, marketingFiles, assetFiles, rootStaticFiles] = await Promise.all([
  listStaticFiles('blogs'),
  listStaticFiles('marketing'),
  listStaticFiles('assets'),
  listStaticFiles(''),
]);

const blogPages = buildStaticLinks(blogFiles, '/blogs');
const marketingPages = buildStaticLinks(marketingFiles, '/marketing');
const assetPages = buildStaticLinks(assetFiles, '/assets');
const otherPages = buildStaticLinks(rootStaticFiles, '/');

const staticCollections = [
  {
    title: `Educational Content (${blogPages.length} Posts)`,
    description: 'In-depth articles about building, financing, design, and land selection.',
    pages: blogPages,
  },
  {
    title: `Marketing Tools (${marketingPages.length} Items)`,
    description: 'Plan catalogs, analytics setup, advertising guides, and signage templates.',
    pages: marketingPages,
  },
  {
    title: `Design Assets (${assetPages.length} Items)`,
    description: 'Brand guidelines, templates, brochures, and marketing collateral.',
    pages: assetPages,
  },
  {
    title: 'Archive & Reference',
    description: 'Legacy pages and operational documentation preserved from prior builds.',
    pages: otherPages,
  },
];

// Main site pages with hero images and enhanced descriptions
const sitePages = [
  {
    title: 'About CORELOT',
    slug: '/about',
    description: 'Learn our story, service area across Northern & Central Virginia, what drives our builder-first approach, and why we partner exclusively with WL Martin Homes designs for predictable quality.',
    heroImage: '/images/brands/corelot.svg',
    category: 'Company'
  },
  {
    title: 'Build Process',
    slug: '/process',
    description: 'Complete 8-phase build timeline from initial consultation through design retainer, permitting, site preparation, construction milestones, and final walkthrough. Includes FAQs and communication approach.',
    heroImage: '/images/brands/corelot.svg',
    category: 'Resources'
  },
  {
    title: 'Financing Guide',
    slug: '/financing',
    description: 'Understand construction-to-permanent loans, budget components (land, site work, plans, construction), design retainer benefits, example project costs, and our trusted lender partners.',
    heroImage: '/images/brands/corelot.svg',
    category: 'Resources'
  },
  {
    title: 'Frequently Asked Questions',
    slug: '/faq',
    description: 'Comprehensive FAQ covering getting started, land requirements, process timeline, financing options, design choices, construction phases, service area, and post-completion support.',
    heroImage: '/images/brands/corelot.svg',
    category: 'Resources'
  },
  {
    title: 'Contact Us',
    slug: '/contact',
    description: 'Schedule a complimentary consultation to discuss your homesite and project goals. Includes contact information, what to prepare, and next steps after initial inquiry.',
    heroImage: '/images/brands/corelot.svg',
    category: 'Company'
  },
  {
    title: 'Floor Plans Library',
    slug: '/plans',
    description: `Browse all ${plans.length} CORELOT and WL Martin floor plans with square footage, bed/bath counts, galleries, and structural options. Each plan validated as code with consistent slugs and metadata.`,
    heroImage: '/images/brands/corelot.svg',
    category: 'Catalog'
  },
  {
    title: 'Available Homesites',
    slug: '/land',
    description: `Explore ${land.length} CORELOT-ready land packages across Virginia with status, location details, gallery images, and WL Martin plan compatibility guidance. All listings validated before publishing.`,
    heroImage: '/images/brands/corelot.svg',
    category: 'Catalog'
  },
];

const structuredData = [
  {
    '@context': 'https://schema.org',
    '@type': 'ItemList',
    name: 'CORELOT Plans',
    itemListElement: plans.map((plan, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      url: absoluteUrl(`/plans/${plan.id}/`, Astro.site),
      name: plan.data.title,
    })),
  },
  {
    '@context': 'https://schema.org',
    '@type': 'ItemList',
    name: 'Available Land',
    itemListElement: land.map((lot, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      url: absoluteUrl(`/land/${lot.id}/`, Astro.site),
      name: lot.data.address,
    })),
  },
  {
    '@context': 'https://schema.org',
    '@type': 'ItemList',
    name: 'Static HTML & Legacy Resources',
    itemListElement: staticCollections
      .flatMap((collection) => collection.pages)
      .map((page, index) => ({
        '@type': 'ListItem',
        position: index + 1,
        url: absoluteUrl(prefixWithBase(page.href, basePath), Astro.site),
        name: page.title,
      })),
  },
];
---
<BaseLayout
  title="CORELOT Homes | Site Catalog"
  description="Browse all pages, floor plans, and resources for CORELOT Homes—your on-your-lot builder in Virginia."
  canonicalPath="/"
  structuredData={structuredData}
>
  <header class="catalog-header">
    <div class="hero-panel" aria-labelledby="hero-title">
      <div class="hero-copy">
        <p class="pill">SEO-first site map</p>
        <h1 id="hero-title">Every CORELOT resource, verified and link-checked.</h1>
        <p class="lede">No more 404s: every Astro page, legacy HTML, and blog post lives here with crawlable slugs, accessible alt text, and partner imagery.</p>
        <div class="hero-links">
          <a class="btn-link" href={prefixWithBase('/contact', basePath)}>Schedule a consult</a>
          <a class="btn-link ghost" href={prefixWithBase('/plans', basePath)}>Browse floor plans</a>
        </div>
      </div>
      <div class="brand-logos" aria-label="Partner site previews">
        <a class="logo-card" href="https://www.corelothomes.com" target="_blank" rel="noopener">
          <img src={prefixWithBase('/images/brands/corelot.svg', basePath)} alt="CORELOT Homes website" loading="lazy" />
          <span>corelothomes.com</span>
        </a>
        <a class="logo-card" href="https://www.wlmartinhomes.com" target="_blank" rel="noopener">
          <img src={prefixWithBase('/images/brands/wl-martin.svg', basePath)} alt="WL Martin Homes website" loading="lazy" />
          <span>wlmartinhomes.com</span>
        </a>
      </div>
    </div>

    <div class="catalog-intro">
      <h2>Complete Site Catalog</h2>
      <p class="lede">Browse all pages, floor plans, homesites, and resources. Each item displays its slug (URL path) for easy reference and navigation.</p>
    </div>
  </header>

  <section class="catalog-section">
    <div class="section-header">
      <h2>Core Pages</h2>
      <p class="section-description">Essential information about CORELOT, the build process, financing, and how to get started.</p>
    </div>
    <div class="catalog-grid">
      {sitePages.map((page) => (
        <a href={prefixWithBase(page.slug, basePath)} class="catalog-card">
          <div class="catalog-image">
            <img src={prefixWithBase(page.heroImage, basePath)} alt={page.title} />
          </div>
          <div class="catalog-content">
            <p class="catalog-category">{page.category}</p>
            <h3>{page.title}</h3>
            <p class="catalog-description">{page.description}</p>
            <p class="catalog-slug">{prefixWithBase(page.slug, basePath)}</p>
          </div>
        </a>
      ))}
    </div>
  </section>

  <section class="catalog-section">
    <div class="section-header">
      <h2>Floor Plans ({plans.length})</h2>
      <p class="section-description">Complete CORELOT and WL Martin Homes collection. Each plan page includes galleries, specifications, structural options, and pricing guidance. Sorted by square footage (largest first).</p>
    </div>
    <div class="catalog-grid">
      {plans.map((plan) => (
        <a href={prefixWithBase(`/plans/${plan.id}/`, basePath)} class="catalog-card">
          <div class="catalog-image">
            <img src={prefixWithBase(plan.data.heroImage, basePath)} alt={plan.data.title} />
          </div>
          <div class="catalog-content">
            <p class="catalog-category">{plan.data.category}</p>
            <h3>{plan.data.title}</h3>
            <p class="catalog-description">{plan.data.sqft} sqft • {plan.data.beds} beds • {plan.data.baths} baths</p>
            <p class="catalog-slug">{prefixWithBase(`/plans/${plan.id}/`, basePath)}</p>
          </div>
        </a>
      ))}
    </div>
  </section>

  <section class="catalog-section">
    <div class="section-header">
      <h2>Available Homesites ({land.length})</h2>
      <p class="section-description">CORELOT-ready land packages across Northern and Central Virginia. Each listing includes location details, availability status, site photos, and compatible floor plan recommendations.</p>
    </div>
    <div class="catalog-grid">
      {land.map((parcel) => (
        <a href={prefixWithBase(`/land/${parcel.id}/`, basePath)} class="catalog-card">
          <div class="catalog-image">
            <img src={prefixWithBase(parcel.data.heroImage, basePath)} alt={parcel.data.address} />
          </div>
          <div class="catalog-content">
            <p class="catalog-category">Homesite</p>
            <h3>{parcel.data.address}</h3>
            <p class="catalog-description">{parcel.data.status}</p>
            <p class="catalog-slug">{prefixWithBase(`/land/${parcel.id}/`, basePath)}</p>
          </div>
        </a>
      ))}
    </div>
  </section>

  <section id="library">
    <div class="library-header">
      <h2>Additional Resources & Archives</h2>
      <p class="library-description">Legacy content, marketing materials, design assets, and educational blog posts. All static HTML preserved from previous site versions.</p>
    </div>
    <div class="link-grid">
      {staticCollections.map((collection) => (
        <div class="link-category">
          <h3>{collection.title}</h3>
          <p class="category-description">{collection.description}</p>
          <ul>
            {collection.pages.map((page) => (
              <li><a href={prefixWithBase(page.href, basePath)}>{page.title}</a></li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  </section>
</BaseLayout>

<style>
.catalog-header {
  margin-bottom: 3rem;
}

.hero-panel {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  align-items: center;
  padding: 2rem;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  background: #f8f9fb;
}
.hero-copy h1 {
  margin: 0.5rem 0 0.75rem;
  font-size: 2rem;
}
.hero-links {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-top: 1rem;
}
.btn-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.65rem 1.1rem;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 700;
  background: #cc5500;
  color: #fff;
  border: 1px solid #cc5500;
}
.btn-link.ghost {
  background: transparent;
  color: #cc5500;
}
.btn-link:hover,
.btn-link:focus-visible {
  box-shadow: 0 10px 30px rgba(204, 85, 0, 0.2);
}
.brand-logos {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  justify-content: flex-start;
}
.logo-card {
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  background: #fff;
  text-decoration: none;
  color: inherit;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
}
.logo-card img {
  height: 52px;
  width: auto;
  object-fit: contain;
}
.logo-card span {
  color: #4b5563;
  font-weight: 600;
}

.catalog-intro {
  text-align: center;
  padding-bottom: 2rem;
  border-bottom: 2px solid #e5e7eb;
}
.catalog-intro h2 {
  color: #0d2340;
  margin-bottom: 0.75rem;
}
.catalog-intro .lede {
  font-size: 1.1rem;
  color: #4b5563;
  line-height: 1.6;
  max-width: 70ch;
  margin: 0 auto;
}

.catalog-section {
  margin-bottom: 4rem;
}

.section-header {
  margin-bottom: 2rem;
}
.section-header h2 {
  color: #0d2340;
  font-size: 1.8rem;
  margin-bottom: 0.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 3px solid #cc5500;
}
.section-description {
  color: #6b7280;
  font-size: 1.05rem;
  line-height: 1.6;
  margin-top: 0.75rem;
}

.catalog-section h2 {
  color: #0d2340;
  font-size: 1.8rem;
  margin-bottom: 1.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 3px solid #cc5500;
}

.catalog-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1.5rem;
}

.catalog-card {
  display: flex;
  flex-direction: column;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
  transition: all 0.3s;
  text-decoration: none;
  color: inherit;
}
.catalog-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
  border-color: #cc5500;
}

.catalog-image {
  width: 100%;
  height: 200px;
  background: #f8f9fb;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
.catalog-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.catalog-content {
  padding: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  flex: 1;
}

.catalog-category {
  color: #cc5500;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin: 0;
}

.catalog-content h3 {
  color: #0d2340;
  margin: 0;
  font-size: 1.1rem;
  line-height: 1.3;
}

.catalog-description {
  color: #6b7280;
  font-size: 0.9rem;
  line-height: 1.5;
  margin: 0;
  flex: 1;
}

.catalog-slug {
  color: #0d2340;
  font-family: 'Courier New', Courier, monospace;
  font-size: 0.85rem;
  background: #f8f9fb;
  padding: 0.5rem;
  border-radius: 6px;
  margin: 0;
  font-weight: 600;
  border: 1px solid #e5e7eb;
}

.link-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  gap: 1rem;
}
.link-grid ul {
  padding-left: 1rem;
}

#library {
  margin-top: 4rem;
  padding-top: 2rem;
  border-top: 2px solid #e5e7eb;
}

.library-header {
  margin-bottom: 2.5rem;
  text-align: center;
}
.library-header h2 {
  color: #0d2340;
  margin-bottom: 0.75rem;
  font-size: 1.8rem;
}
.library-description {
  color: #6b7280;
  font-size: 1.05rem;
  line-height: 1.6;
  max-width: 70ch;
  margin: 0 auto;
}

.link-category {
  background: #f8f9fb;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}
.link-category h3 {
  color: #0d2340;
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.15rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #cc5500;
}
.category-description {
  color: #6b7280;
  font-size: 0.9rem;
  line-height: 1.5;
  margin-bottom: 1rem;
  font-style: italic;
}
</style>
